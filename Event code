create synonym DIM_CPP_CUST_H_PROD_POL_REL for SDSNZD01_CPP..DIM_CPP_CUST_H_PROD_POL_REL;
create synonym FCT_CI_MOTOR_CLAIMANT_SATISFACTION  for INSNZP01_CL..FCT_CI_MOTOR_CLAIMANT_SATISFACTION ;
create synonym CCR_CC_CLAIM  for SDSNZS01_CCR..CCR_CC_CLAIM;
　
　
CREATE or REPLACE VIEW EVENT_100_V AS 
	(
		WITH CTE_EVENT100A AS 
		(
			SELECT DISTINCT
				 B.CUST_NUM
				,A.PRDT_HOLDNG_NUM
				,A.EVENT_TIMESTAMP
				,B.POL_NUM
				,B.ENTITY_TYPE_CODE
				,B.BRND_CODE
				,B.GCIS_ID
				,B.PRDT_SYS_CODE
				,B.SUB_LOB_CODE						
			FROM
			(	SELECT DISTINCT   
					 CLAIM.CLAIM_NUMBER	
					,CLAIM.SURVEY_DUE_DATE as SURVEY_DATE
					,CLAIM.SURVEY_DUE_DATE AS EVENT_TIMESTAMP
					,CASE 
						WHEN CLAIM.BRAND in('AA Insurance') then 'AAI' 
						WHEN CLAIM.BRAND in('Apia') then 'APIA' 
						WHEN CLAIM.BRAND in('Just Car Insurance') then 'JCI' 
						WHEN CLAIM.BRAND in('Bingle') then 'BINGLE' 
						WHEN CLAIM.BRAND in('Shannons') then 'SHANNONS' 
						WHEN CLAIM.BRAND in('Resilium') then 'AMP' 
						WHEN CLAIM.BRAND in('Essentials by AAI') then 'ESS' 
						WHEN CLAIM.BRAND in('Suncorp') then 'SUN'
						WHEN CLAIM.BRAND like('Vero%') then 'VERO' 
							ELSE CLAIM.BRAND end as BRND_CDE 
					,CLAIM.POLICY_NUMBER 
					,null as PRDT_HOLDNG_NUM
				FROM FCT_CI_MOTOR_CLAIMANT_SATISFACTION CLAIM 
　
					LEFT JOIN CCR_CC_CLAIM CC
					ON CC.CLAIMNUMBER = CLAIM.CLAIM_NUMBER
			
				WHERE CLAIM.SURVEY_DUE_DATE >= NOW() - 7
			) A
			INNER JOIN				
			(	SELECT DISTINCT 
					 PRDT_SYS_CODE
					,POL_NUM
					,CUST_NUM
					,ENTTYP_CODE AS ENTITY_TYPE_CODE
					,START_DATE
					,END_DATE
					,BRND_CODE
					,LOB_CODE
					,SUB_LOB_CODE
					,PRDT_ID
					,GCIS_ID
				FROM DIM_CPP_CUST_H_PROD_POL_REL
				WHERE LOB_CODE in ('CI') 
					AND	OWNING_RSHIP_IND = 'Y'
					AND BASE_PRODUCT_IND = 'Y'
			)B
								
			ON 		A.POLICY_NUMBER = B.POL_NUM
			AND 	A.BRND_CDE = B.BRND_CODE
			AND 	A.EVENT_TIMESTAMP <= B.END_DATE
			AND 	A.EVENT_TIMESTAMP >= B.START_DATE 
		)
		
		SELECT	
			CAST(100 AS INTEGER) AS EVENT_ID,
			CAST(CASE 
					WHEN BRND_CODE = 'AAMI' AND SUB_LOB_CODE = 'CI' THEN 1 
					WHEN BRND_CODE = 'APIA' AND SUB_LOB_CODE = 'CI' THEN 2 
					WHEN BRND_CODE = 'BINGLE' AND SUB_LOB_CODE = 'CI' THEN 3
					WHEN BRND_CODE = 'CIL' AND SUB_LOB_CODE = 'CI' THEN 4
					WHEN BRND_CODE = 'GIO' AND SUB_LOB_CODE = 'CI' THEN 5 
					WHEN BRND_CODE = 'JCI' AND SUB_LOB_CODE = 'CI' THEN 6
					WHEN BRND_CODE = 'SHANNONS' AND SUB_LOB_CODE = 'CI'  THEN 7
					WHEN BRND_CODE = 'SUN' AND SUB_LOB_CODE = 'CI'  THEN 8
					WHEN BRND_CODE = 'VERO' AND SUB_LOB_CODE = 'CI' THEN 9
					WHEN (BRND_CODE = 'AMP' OR BRND_CODE = 'RESILIUM') AND SUB_LOB_CODE = 'CI' THEN 10
						ELSE 999999
				  END AS INTEGER) AS EVENT_DETAIL_ID,
			CAST(EVENT_TIMESTAMP AS TIMESTAMP) AS EVENT_TIMESTAMP,
			CAST(CUST_NUM AS BIGINT) AS CUST_NUM,
			CAST(ENTITY_TYPE_CODE AS VARCHAR(20)) AS ENTITY_TYPE_CODE,
			CAST(GCIS_ID AS BIGINT) AS GCIS_ID,
			CAST(NULL AS VARCHAR(30)) AS PRDT_SYS_CUST_NUM,
			CAST(PRDT_SYS_CODE AS VARCHAR(10)) AS PRDT_SYS_CODE,
			CAST(POL_NUM AS VARCHAR(20)) AS POL_NUM,
			CAST(PRDT_HOLDNG_NUM AS VARCHAR(20)) AS PRDT_HOLDNG_NUM,
			CAST(NULL AS VARCHAR(50)) AS INTERACTION_IDENTIFIER,
			CAST(SETNZP01..hash8(EVENT_ID||EVENT_DETAIL_ID||EVENT_TIMESTAMP||CUST_NUM||ENTITY_TYPE_CODE||COALESCE(GCIS_ID,0)||COALESCE(PRDT_SYS_CUST_NUM,'')||
				COALESCE(PRDT_SYS_CODE,'')||COALESCE(POL_NUM,'')||COALESCE(PRDT_HOLDNG_NUM,'')||COALESCE(INTERACTION_IDENTIFIER,'')) AS BIGINT) AS OLAP_KEY
		FROM 	CTE_EVENT100A	
	);
